# Subquery tests for Teide SQL

# --- Setup ---

statement ok
CREATE TABLE orders (id INTEGER, customer_id INTEGER, amount REAL)

statement ok
INSERT INTO orders VALUES (1, 10, 100.0), (2, 10, 200.0), (3, 20, 150.0), (4, 30, 300.0), (5, 20, 50.0)

statement ok
CREATE TABLE customers (id INTEGER, name VARCHAR)

statement ok
INSERT INTO customers VALUES (10, 'alice'), (20, 'bob'), (30, 'carol'), (40, 'dave')

# --- IN subquery ---

query IT rowsort
SELECT id, name FROM customers WHERE id IN (SELECT customer_id FROM orders)
----
10 alice
20 bob
30 carol

query IT
SELECT id, name FROM customers WHERE id NOT IN (SELECT customer_id FROM orders)
----
40 dave

# --- Subquery in FROM (derived table) ---

query IR
SELECT customer_id, total FROM (SELECT customer_id, SUM(amount) AS total FROM orders GROUP BY customer_id) ORDER BY customer_id
----
10 300.0
20 200.0
30 300.0

# --- Nested subquery ---

query I
SELECT COUNT(*) FROM orders WHERE customer_id IN (SELECT id FROM customers WHERE name IN ('alice', 'bob'))
----
4
